{% extends 'base.html' %}

{% block title %}Chat with Gemini{% endblock %}

{% block content %}
<div class="container mx-auto p-4 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-6 py-4">
            <h1 class="text-xl font-bold text-white text-center">üí¨ Chat with Gemini AI</h1>
        </div>
        
        <!-- Chat Box -->
        <div id="chat-box" class="h-96 overflow-y-auto p-4 space-y-4 bg-slate-50">
            <!-- Messages will appear here -->
        </div>
        
        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-slate-200">
            <div class="flex gap-2">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß..."
                    class="flex-1 px-4 py-3 rounded-lg border border-slate-300 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 outline-none transition-all text-right"
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                >
                <button 
                    onclick="sendMessage()"
                    class="px-6 py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors font-semibold"
                >
                    ÿ•ÿ±ÿ≥ÿßŸÑ
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 80%;
        word-wrap: break-word;
    }
    .message.user {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
        margin-right: auto;
        border-bottom-right-radius: 4px;
    }
    .message.model {
        background: white;
        color: #334155;
        margin-left: auto;
        border: 1px solid #E2E8F0;
        border-bottom-left-radius: 4px;
    }
    .message.error {
        background: #FEE2E2;
        color: #DC2626;
        margin-left: auto;
        border: 1px solid #FECACA;
    }
    .message strong {
        display: block;
        font-size: 0.75rem;
        margin-bottom: 4px;
        opacity: 0.8;
    }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 12px;
        width: fit-content;
        margin-left: auto;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #94A3B8;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>

<script>
    // Store chat history for multi-turn context
    let chatHistory = []; 

    function sendMessage() {
        const userInput = document.getElementById('user-input');
        const prompt = userInput.value.trim();
        userInput.value = '';

        if (!prompt) return;

        // Display user message
        displayMessage(prompt, 'user');

        // Add to history
        chatHistory.push({ 'role': 'user', 'text': prompt });

        // Show typing indicator
        showTypingIndicator();

        // Send to API
        fetch("{% url 'chat:chat_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: prompt,
                history: chatHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            if (data.response) {
                displayMessage(data.response, 'model');
                chatHistory.push({ 'role': 'model', 'text': data.response });
            } else if (data.error) {
                displayMessage(data.error, 'error');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Fetch error:', error);
            displayMessage("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ", 'error');
        });
    }

    function displayMessage(text, role) {
        const chatBox = document.getElementById('chat-box');
        const messageElement = document.createElement('div');
        messageElement.className = 'message ' + role;
        
        const roleLabels = {
            'user': 'ÿ£ŸÜÿ™',
            'model': 'Gemini',
            'error': 'ÿÆÿ∑ÿ£'
        };
        
        messageElement.innerHTML = `<strong>${roleLabels[role] || role}:</strong> ${text}`;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
        const chatBox = document.getElementById('chat-box');
        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        chatBox.appendChild(indicator);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }
</script>
{% endblock %}