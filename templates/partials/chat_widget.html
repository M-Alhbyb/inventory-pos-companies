<!-- Floating Chat Widget with Expandable Interface and Markdown Support -->
<div id="chat-widget" class="fixed bottom-6 left-6 z-50">
    <!-- Chat Toggle Button -->
    <button 
        id="chat-toggle-btn"
        onclick="toggleChatWidget()"
        class="w-14 h-14 bg-gradient-to-br from-teal-500 to-teal-600 text-white rounded-full shadow-lg hover:shadow-xl hover:scale-110 transition-all flex items-center justify-center group"
        title="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ"
    >
        <i id="chat-icon" class="fas fa-comment-dots text-xl group-hover:scale-110 transition-transform"></i>
        <i id="close-icon" class="fas fa-times text-xl hidden"></i>
    </button>
    
    <!-- Notification Badge -->
    <span id="chat-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse">
        1
    </span>
    
    <!-- Chat Window -->
    <div 
        id="chat-window" 
        class="hidden absolute bottom-20 left-0 bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200 animate-fade-in transition-all duration-300"
        style="width: 400px; height: 500px;"
    >
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h3>
                    <p class="text-teal-100 text-xs">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù€ Gemini AI</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="clearChatHistory()" class="text-white/70 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-colors" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                    <i class="fas fa-trash-alt text-sm"></i>
                </button>
                <button onclick="toggleChatExpand()" class="text-white/70 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-colors" title="ØªÙˆØ³ÙŠØ¹/ØªØµØºÙŠØ±">
                    <i id="expand-icon" class="fas fa-expand text-sm"></i>
                </button>
                <button onclick="toggleChatWidget()" class="text-white/70 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-colors" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="fas fa-minus text-sm"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="overflow-y-auto p-4 space-y-3 bg-slate-50" style="height: calc(100% - 180px);">
            <!-- Welcome Message -->
            <div class="chat-message model">
                <div class="flex items-start gap-2">
                    <div class="w-7 h-7 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-teal-600 text-xs"></i>
                    </div>
                    <div class="bg-white rounded-lg rounded-tr-none p-3 shadow-sm border border-slate-100 max-w-[85%]">
                        <div class="text-slate-700 text-sm markdown-content">
                            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.</p>
                            <p class="mt-2">ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:</p>
                            <ul class="list-disc list-inside mt-1 text-slate-600">
                                <li>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</li>
                                <li>Ù…Ø¹Ø±ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</li>
                                <li>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</li>
                                <li>ØªÙˆÙ‚Ø¹Ø§Øª Ù†ÙØ§Ø° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div id="quick-actions" class="px-3 py-2 bg-white border-t border-slate-100 flex gap-2 overflow-x-auto">
            <button onclick="sendQuickMessage('Ù…Ø§ Ù‡ÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ')" class="flex-shrink-0 px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
                ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
            </button>
            <button onclick="sendQuickMessage('Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŸ')" class="flex-shrink-0 px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
                âš ï¸ Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶
            </button>
            <button onclick="sendQuickMessage('Ù…Ù† Ù‡Ù… Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ø£ÙƒØ«Ø± Ø¯ÙŠÙˆÙ†Ø§Ù‹ØŸ')" class="flex-shrink-0 px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
                ğŸ’° Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠÙˆÙ†
            </button>
            <button onclick="sendQuickMessage('Ù…Ø§ Ù‡ÙŠ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹ØŸ')" class="flex-shrink-0 px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
                ğŸ† Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
            </button>
        </div>
        
        <!-- Chat Input -->
        <div class="p-3 bg-white border-t border-slate-200">
            <div class="flex gap-2">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
                    class="flex-1 px-4 py-2.5 rounded-full border border-slate-300 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 outline-none text-sm text-right"
                    onkeypress="if(event.key === 'Enter') sendChatMessage()"
                >
                <button 
                    onclick="sendChatMessage()"
                    id="send-btn"
                    class="w-10 h-10 bg-teal-500 text-white rounded-full hover:bg-teal-600 transition-colors flex items-center justify-center"
                >
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Chat widget animations */
    #chat-widget .animate-fade-in {
        animation: chatFadeIn 0.3s ease-out;
    }
    
    @keyframes chatFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    /* Chat window sizes */
    #chat-window.expanded {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        z-index: 9999 !important;
    }
    
    @media (max-width: 768px) {
        #chat-window {
            width: calc(100vw - 48px) !important;
            max-width: 400px;
        }
    }
    
    /* Chat message styles */
    .chat-message.user .message-content {
        background: linear-gradient(135deg, #0D9488, #14B8A6);
        color: white;
    }
    
    .chat-message.model .message-content {
        background: white;
        border: 1px solid #e2e8f0;
    }
    
    .chat-message.error .message-content {
        background: #FEE2E2;
        color: #DC2626;
        border: 1px solid #FECACA;
    }
    
    /* Markdown Styles */
    .markdown-content {
        line-height: 1.6;
    }
    
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        font-weight: 700;
        margin-top: 0.75em;
        margin-bottom: 0.5em;
        color: #1e293b;
    }
    
    .markdown-content h1 { font-size: 1.25em; }
    .markdown-content h2 { font-size: 1.15em; }
    .markdown-content h3 { font-size: 1.05em; }
    
    .markdown-content p {
        margin-bottom: 0.5em;
    }
    
    .markdown-content ul, .markdown-content ol {
        margin: 0.5em 0;
        padding-right: 1.5em;
    }
    
    .markdown-content li {
        margin-bottom: 0.25em;
    }
    
    .markdown-content code {
        background: #f1f5f9;
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
        color: #0f766e;
    }
    
    .markdown-content pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1em;
        border-radius: 8px;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    
    .markdown-content pre code {
        background: transparent;
        color: inherit;
        padding: 0;
    }
    
    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.5em 0;
        font-size: 0.9em;
    }
    
    .markdown-content th, .markdown-content td {
        border: 1px solid #e2e8f0;
        padding: 0.5em;
        text-align: right;
    }
    
    .markdown-content th {
        background: #f8fafc;
        font-weight: 600;
    }
    
    .markdown-content blockquote {
        border-right: 3px solid #14b8a6;
        padding-right: 1em;
        margin: 0.5em 0;
        color: #64748b;
        font-style: italic;
    }
    
    .markdown-content strong {
        font-weight: 600;
        color: #0f172a;
    }
    
    .markdown-content em {
        font-style: italic;
    }
    
    .markdown-content a {
        color: #0d9488;
        text-decoration: underline;
    }
    
    .markdown-content hr {
        border: none;
        border-top: 1px solid #e2e8f0;
        margin: 1em 0;
    }
    
    /* Typing indicator */
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #94A3B8;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    /* Custom scrollbar for chat */
    #chat-messages::-webkit-scrollbar {
        width: 5px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background: #CBD5E1;
        border-radius: 10px;
    }
    
    /* Quick actions scrollbar */
    #quick-actions::-webkit-scrollbar {
        height: 4px;
    }
    
    #quick-actions::-webkit-scrollbar-thumb {
        background: #CBD5E1;
        border-radius: 10px;
    }
</style>

<script>
    // Chat state
    let chatHistory = [];
    let chatWidgetOpen = false;
    let chatExpanded = false;
    
    // Configure marked for RTL and security
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });
    }
    
    function toggleChatWidget() {
        const chatWindow = document.getElementById('chat-window');
        const chatIcon = document.getElementById('chat-icon');
        const closeIcon = document.getElementById('close-icon');
        const badge = document.getElementById('chat-badge');
        
        chatWidgetOpen = !chatWidgetOpen;
        
        if (chatWidgetOpen) {
            chatWindow.classList.remove('hidden');
            chatIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            badge.classList.add('hidden');
            document.getElementById('chat-input').focus();
        } else {
            chatWindow.classList.add('hidden');
            chatIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }
    }
    
    function toggleChatExpand() {
        const chatWindow = document.getElementById('chat-window');
        const expandIcon = document.getElementById('expand-icon');
        
        chatExpanded = !chatExpanded;
        
        if (chatExpanded) {
            chatWindow.classList.add('expanded');
            expandIcon.classList.remove('fa-expand');
            expandIcon.classList.add('fa-compress');
        } else {
            chatWindow.classList.remove('expanded');
            expandIcon.classList.remove('fa-compress');
            expandIcon.classList.add('fa-expand');
        }
    }
    
    function sendQuickMessage(message) {
        document.getElementById('chat-input').value = message;
        sendChatMessage();
    }
    
    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const prompt = input.value.trim();
        input.value = '';
        
        if (!prompt) return;
        
        // Display user message
        displayChatMessage(prompt, 'user');
        
        // Add to history
        chatHistory.push({ role: 'user', text: prompt });
        
        // Show typing indicator
        showTypingIndicator();
        
        // Send to API
        fetch("{% url 'chat:chat_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: prompt,
                history: chatHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            if (data.response) {
                displayChatMessage(data.response, 'model');
                chatHistory.push({ role: 'model', text: data.response });
            } else if (data.error) {
                displayChatMessage(data.error, 'error');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Chat error:', error);
            displayChatMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        });
    }
    
    function parseMarkdown(text) {
        if (typeof marked !== 'undefined') {
            try {
                return marked.parse(text);
            } catch (e) {
                console.error('Markdown parse error:', e);
                return escapeHtml(text);
            }
        }
        // Fallback: simple text with line breaks
        return escapeHtml(text).replace(/\n/g, '<br>');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function displayChatMessage(text, role) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;
        
        const icons = {
            user: '<i class="fas fa-user text-teal-600 text-xs"></i>',
            model: '<i class="fas fa-robot text-teal-600 text-xs"></i>',
            error: '<i class="fas fa-exclamation-circle text-red-500 text-xs"></i>'
        };
        
        const bgColors = {
            user: 'bg-teal-100',
            model: 'bg-teal-100',
            error: 'bg-red-100'
        };
        
        const alignment = role === 'user' ? 'flex-row-reverse' : '';
        const roundedCorner = role === 'user' ? 'rounded-tl-none' : 'rounded-tr-none';
        const msgBg = role === 'user' ? 'bg-gradient-to-br from-teal-500 to-teal-600 text-white' : 'bg-white border border-slate-100';
        
        // Parse markdown for model responses, escape HTML for user messages
        const content = role === 'model' ? parseMarkdown(text) : escapeHtml(text);
        
        messageDiv.innerHTML = `
            <div class="flex items-start gap-2 ${alignment}">
                <div class="w-7 h-7 ${bgColors[role]} rounded-full flex items-center justify-center flex-shrink-0">
                    ${icons[role]}
                </div>
                <div class="${msgBg} rounded-lg ${roundedCorner} p-3 shadow-sm max-w-[85%]">
                    <div class="text-sm markdown-content">${content}</div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function showTypingIndicator() {
        const messagesContainer = document.getElementById('chat-messages');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'chat-message model';
        typingDiv.innerHTML = `
            <div class="flex items-start gap-2">
                <div class="w-7 h-7 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-teal-600 text-xs"></i>
                </div>
                <div class="bg-white rounded-lg rounded-tr-none p-3 shadow-sm border border-slate-100">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }
    
    function clearChatHistory() {
        chatHistory = [];
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = `
            <div class="chat-message model">
                <div class="flex items-start gap-2">
                    <div class="w-7 h-7 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-teal-600 text-xs"></i>
                    </div>
                    <div class="bg-white rounded-lg rounded-tr-none p-3 shadow-sm border border-slate-100 max-w-[85%]">
                        <div class="text-slate-700 text-sm markdown-content">
                            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.</p>
                            <p class="mt-2">ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:</p>
                            <ul class="list-disc list-inside mt-1 text-slate-600">
                                <li>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</li>
                                <li>Ù…Ø¹Ø±ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</li>
                                <li>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</li>
                                <li>ØªÙˆÙ‚Ø¹Ø§Øª Ù†ÙØ§Ø° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
</script>
