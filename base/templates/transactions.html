{% extends 'base.html' %}
{% load static %}

{% block title %}المعاملات - إدارة المخزون{% endblock %}

{% block page_title %}المعاملات{% endblock %}
{% block page_subtitle %}عرض وإدارة جميع المعاملات{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <!-- Total Transactions -->
    <div class="bg-white rounded-xl shadow-md p-4 border border-slate-200 hover:shadow-lg transition-all group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-medium text-slate-600 mb-1">إجمالي المعاملات</p>
                <h3 class="text-2xl font-bold text-slate-800">{{ total_transactions }}</h3>
            </div>
            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-slate-500 to-slate-600 flex items-center justify-center shadow group-hover:scale-110 transition-transform">
                <i class="fas fa-receipt text-white text-lg"></i>
            </div>
        </div>
    </div>
    
    <!-- Take Transactions -->
    <div class="bg-white rounded-xl shadow-md p-4 border border-red-200 hover:shadow-lg transition-all group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-medium text-red-600 mb-1">معاملات أخذ</p>
                <h3 class="text-2xl font-bold text-red-700">{{ total_take }}</h3>
            </div>
            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow group-hover:scale-110 transition-transform">
                <i class="fas fa-shopping-cart text-white text-lg"></i>
            </div>
        </div>
    </div>
    
    <!-- Payment Transactions -->
    <div class="bg-white rounded-xl shadow-md p-4 border border-green-200 hover:shadow-lg transition-all group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-medium text-green-600 mb-1">معاملات دفع</p>
                <h3 class="text-2xl font-bold text-green-700">{{ total_payment }}</h3>
            </div>
            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow group-hover:scale-110 transition-transform">
                <i class="fas fa-dollar-sign text-white text-lg"></i>
            </div>
        </div>
    </div>
    
    <!-- Restore Transactions -->
    <div class="bg-white rounded-xl shadow-md p-4 border border-blue-200 hover:shadow-lg transition-all group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-medium text-blue-600 mb-1">معاملات إرجاع</p>
                <h3 class="text-2xl font-bold text-blue-700">{{ total_restore }}</h3>
            </div>
            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow group-hover:scale-110 transition-transform">
                <i class="fas fa-undo text-white text-lg"></i>
            </div>
        </div>
    </div>

</div>

<!-- Filters and Search -->
<div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 mb-6">
    <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
                <i class="fas fa-search ml-1"></i>
                البحث
            </label>
            <input type="text" name="q" value="{{ search_query }}" 
                placeholder="ابحث برقم المعاملة أو اسم المستخدم..."
                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-right">
        </div>
        
        <!-- Transaction Type Filter -->
        <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
                <i class="fas fa-filter ml-1"></i>
                نوع المعاملة
            </label>
            <select name="type" 
                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-right">
                <option value="all" {% if current_type == 'all' %}selected{% endif %}>الكل</option>
                <option value="take" {% if current_type == 'take' %}selected{% endif %}>أخذ</option>
                <option value="payment" {% if current_type == 'payment' %}selected{% endif %}>دفع</option>
                <option value="restore" {% if current_type == 'restore' %}selected{% endif %}>إرجاع</option>
                <option value="fees" {% if current_type == 'fees' %}selected{% endif %}>منصرف</option>
            </select>
        </div>
        
        <!-- User Type Filter -->
        <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
                <i class="fas fa-users ml-1"></i>
                نوع المستخدم
            </label>
            <select name="user_type" 
                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-right">
                <option value="all" {% if current_user_type == 'all' %}selected{% endif %}>الكل</option>
                <option value="merchant" {% if current_user_type == 'merchant' %}selected{% endif %}>تجار</option>
                <option value="representative" {% if current_user_type == 'representative' %}selected{% endif %}>مندوبين</option>
            </select>
        </div>
        
        <!-- Status Filter -->
        <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
                <i class="fas fa-clock ml-1"></i>
                حالة المعاملة
            </label>
            <select name="status" 
                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-right">
                <option value="all" {% if current_status == 'all' %}selected{% endif %}>الكل</option>
                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>معلق</option>
                <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>موافق</option>
                <option value="rejected" {% if current_status == 'rejected' %}selected{% endif %}>مرفوض</option>
            </select>
        </div>
        
        <!-- Search Button (Full Width on Mobile) -->
        <div class="md:col-span-4 flex gap-3">
            <button type="submit" 
                class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition-all shadow-md hover:shadow-lg font-medium">
                <i class="fas fa-search ml-2"></i>
                بحث
            </button>
            <a href="{% url 'base:transactions' %}" 
                class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 transition-all font-medium">
                <i class="fas fa-redo ml-2"></i>
                إعادة تعيين
            </a>
        </div>
    </form>
    <form method="POST" class="flex gap-3 items-center justify-center mt-4">
        {% csrf_token %}
        <input type="hidden" name="export" value="1">
        <button type="submit"
            class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition-all shadow-md hover:shadow-lg font-medium">
            <i class="fas fa-file-excel ml-2"></i>
            تصدير المعاملات
        </button>
        <button type="button" onclick="openImportModal()"
            class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700 transition-all shadow-md hover:shadow-lg font-medium">
            <i class="fas fa-file-import ml-2"></i>
            استيراد المعاملات
        </button>
    </form>
</div>

<!-- Transactions Table -->
<div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-list text-slate-600"></i>
            قائمة المعاملات
        </h2>
        <span class="text-sm text-slate-500">
            عرض {{ transactions.count }} من أصل {{ total_transactions }} معاملة
        </span>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="bg-slate-50 border-b-2 border-slate-200">
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">المعاملة</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">المستخدم</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">النوع</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">المنتجات</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">المبلغ</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">التاريخ</th>
                    <th class="text-center py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">الحالة</th>
                    <th class="text-right py-3 px-4 text-xs font-bold text-slate-700 uppercase tracking-wider">الإجراءات</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for transaction in page_obj %}
                <tr class="hover:bg-slate-50 transition-all group">
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                <i class="fas fa-hashtag text-white text-sm"></i>
                            </div>
                            <span class="font-bold text-slate-800 text-lg">{{ transaction.id }}</span>
                        </div>
                    </td>
                    <td class="py-4 px-4">
                        {% if transaction.user %}
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br {% if transaction.user.user_type == 'merchant' %}from-orange-400 to-orange-500{% else %}from-purple-400 to-purple-500{% endif %} flex items-center justify-center shadow-sm">
                                <i class="fas {% if transaction.user.user_type == 'merchant' %}fa-store{% else %}fa-user-tie{% endif %} text-white text-xs"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">{{ transaction.user.get_full_name|default:transaction.user.username }}</p>
                                <p class="text-xs text-slate-500">{% if transaction.user.user_type == 'merchant' %}تاجر{% else %}مندوب{% endif %}</p>
                            </div>
                        </div>
                        {% else %}
                        <span class="text-slate-400 text-sm italic">غير محدد</span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4">
                        {% if transaction.type == 'take' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-100 text-red-700 border border-red-200">
                            <i class="fas fa-shopping-cart"></i>
                            أخذ
                        </span>
                        {% elif transaction.type == 'payment' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200">
                            <i class="fas fa-dollar-sign"></i>
                            دفع
                        </span>
                        {% elif transaction.type == 'restore' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-200">
                            <i class="fas fa-undo"></i>
                            إرجاع
                        </span>
                        {% elif transaction.type == 'fees' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-200">
                            <i class="fas fa-receipt"></i>
                            منصرف
                        </span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4">
                        {% if transaction.items.count > 0 %}
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">
                                {{ transaction.items.count }}
                            </span>
                            <button onclick="toggleProducts({{ transaction.id }})" class="text-blue-600 hover:text-blue-700 text-xs font-medium">
                                عرض المنتجات
                            </button>
                        </div>
                        {% else %}
                        <span class="text-slate-400 text-sm">-</span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4">
                        {% if transaction.amount %}
                        <div class="flex items-center gap-1">
                            <span class="text-lg font-bold text-slate-800">{{ transaction.amount|floatformat:2 }}</span>
                            <img src="{% static 'images/sar_symbol_dark.svg' %}" class="h-4 inline-block" alt="SAR">
                        </div>
                        {% else %}
                        <span class="text-slate-400 text-sm">-</span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-slate-700">{{ transaction.date|date:"Y/m/d" }}</span>
                            <span class="text-xs text-slate-500">{{ transaction.date|date:"h:i A" }}</span>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-center">
                        {% if transaction.status == 'pending' %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700 border border-yellow-200">
                            <i class="fas fa-clock"></i>
                            معلق
                        </span>
                        {% elif transaction.status == 'approved' %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200">
                            <i class="fas fa-check"></i>
                            موافق
                        </span>
                        {% elif transaction.status == 'rejected' %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 border border-red-200">
                            <i class="fas fa-times"></i>
                            مرفوض
                        </span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            {% if transaction.user %}
                            <a href="{% url 'base:representative_detail' transaction.user.id %}" 
                                class="p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all" 
                                title="عرض التفاصيل">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% endif %}
                            {% if transaction.status == 'pending' %}
                            <a href="{% url 'base:approve_transaction' transaction.id %}" 
                                class="p-2 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 transition-all" 
                                title="موافقة">
                                <i class="fas fa-check"></i>
                            </a>
                            <a href="{% url 'base:reject_transaction' transaction.id %}" 
                                class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-all" 
                                title="رفض">
                                <i class="fas fa-times"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <!-- Products Row (Hidden by default) -->
                <tr id="products-{{ transaction.id }}" class="hidden bg-slate-50">
                    <td colspan="8" class="py-4 px-4">
                        <div class="bg-white rounded-lg p-4 border border-slate-200">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50">
                                        <tr class="text-center">
                                            <th class="py-2 px-4">المنتج</th>
                                            <th class="py-2 px-4">الكمية</th>
                                            <th class="py-2 px-4">السعر</th>
                                            <th class="py-2 px-4">الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        {% for item in transaction.items.all %}
                                        <tr class="text-right">
                                            <td class="py-2 px-4">{{ item.product.name }}</td>
                                            <td class="py-2 px-4">{{ item.quantity }}</td>
                                            <td class="py-2 px-4">{{ item.price }}</td>
                                            <td class="py-2 px-4">{{ item.total }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="py-12 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center">
                                <i class="fas fa-inbox text-slate-400 text-2xl"></i>
                            </div>
                            <p class="text-slate-500 font-medium">لا توجد معاملات</p>
                            <p class="text-slate-400 text-sm">جرب تغيير معايير البحث أو الفلترة</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
     </div> 
     
     <!-- Loading Spinner -->
     <div id="loading-spinner" class="hidden py-8 text-center">
         <div class="inline-flex items-center gap-3 px-6 py-3 bg-slate-100 rounded-full">
             <div class="w-5 h-5 border-2 border-slate-300 border-t-blue-500 rounded-full animate-spin"></div>
             <span class="text-slate-600 font-medium">جاري تحميل المزيد...</span>
         </div>
     </div>
     
     <!-- End of List Message -->
     <div id="end-of-list" class="hidden py-6 text-center">
         <span class="text-slate-400 text-sm">تم عرض جميع المعاملات</span>
     </div>

     {% comment "" %}
     {% if page_obj.has_other_pages %}
    <!-- Mobile view -->
    <div class="flex flex-1 justify-between sm:hidden">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">السابق</a>
        {% else %}
            <span class="relative inline-flex items-center rounded-md border border-slate-300 bg-slate-100 px-4 py-2 text-sm font-medium text-slate-400 cursor-not-allowed">السابق</span>
        {% endif %}
        
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="relative ml-3 inline-flex items-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">التالي</a>
        {% else %}
            <span class="relative ml-3 inline-flex items-center rounded-md border border-slate-300 bg-slate-100 px-4 py-2 text-sm font-medium text-slate-400 cursor-not-allowed">التالي</span>
        {% endif %}
    </div>

    <!-- Desktop view -->
    <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
            
        </div>
        <div>
            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                <!-- Previous Page -->
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-slate-400 ring-1 ring-inset ring-slate-300 hover:bg-slate-50 focus:z-20 focus:outline-offset-0">
                        <span class="sr-only">السابق</span>
                        <i class="fas fa-chevron-right h-5 w-5"></i>
                    </a>
                {% else %}
                    <span class="relative inline-flex items-center rounded-r-md px-2 py-2 text-slate-300 ring-1 ring-inset ring-slate-300 cursor-not-allowed">
                        <span class="sr-only">السابق</span>
                        <i class="fas fa-chevron-right h-5 w-5"></i>
                    </span>
                {% endif %}

                <!-- Page Numbers -->
                {% for i in page_obj.paginator.page_range %}
                    {% if page_obj.number == i %}
                        <span aria-current="page" class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">{{ i }}</span>
                    {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                        <a href="?page={{ i }}" class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-slate-900 ring-1 ring-inset ring-slate-300 hover:bg-slate-50 focus:z-20 focus:outline-offset-0">{{ i }}</a>
                    {% endif %}
                {% endfor %}

                <!-- Next Page -->
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-slate-400 ring-1 ring-inset ring-slate-300 hover:bg-slate-50 focus:z-20 focus:outline-offset-0">
                        <span class="sr-only">التالي</span>
                        <i class="fas fa-chevron-left h-5 w-5"></i>
                    </a>
                {% else %}
                    <span class="relative inline-flex items-center rounded-l-md px-2 py-2 text-slate-300 ring-1 ring-inset ring-slate-300 cursor-not-allowed">
                        <span class="sr-only">التالي</span>
                        <i class="fas fa-chevron-left h-5 w-5"></i>
                    </span>
                {% endif %}
            </nav>
        </div>
    </div>
    {% endif %}
{% endcomment %}
</div>
    </div>
</div>

<!-- Import Transactions Modal -->
<div id="import-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeImportModal()"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                        <i class="fas fa-file-import text-white"></i>
                    </div>
                    استيراد المعاملات
                </h3>
                <button onclick="closeImportModal()" class="p-2 rounded-lg hover:bg-slate-100 transition-all text-slate-500 hover:text-slate-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Form -->
            <form id="import-form" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="import">
                {% csrf_token %}
                
                <!-- File Upload Area -->
                <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-green-500 hover:bg-green-50/50 transition-all cursor-pointer mb-4">
                    <input type="file" name="file" id="file-input" accept=".xlsx,.xls,.csv" class="hidden" required>
                    
                    <div id="upload-prompt">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-slate-400 text-2xl"></i>
                        </div>
                        <p class="text-slate-700 font-medium mb-1">اسحب الملف هنا أو انقر للاختيار</p>
                        <p class="text-sm text-slate-500">يدعم ملفات Excel (.xlsx, .xls) و CSV</p>
                    </div>
                    
                    <div id="file-selected" class="hidden">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-file-excel text-green-600 text-2xl"></i>
                        </div>
                        <p id="file-name" class="text-slate-700 font-medium mb-1"></p>
                        <p id="file-size" class="text-sm text-slate-500"></p>
                        <button type="button" onclick="clearFile(event)" class="mt-2 text-red-500 hover:text-red-600 text-sm font-medium">
                            <i class="fas fa-trash ml-1"></i>
                            إزالة الملف
                        </button>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium mb-1">تنسيق الملف المطلوب:</p>
                            <p>يجب أن يحتوي الملف على الأعمدة التالية:</p>
                            <ul class="list-disc list-inside mt-1 mr-2 text-blue-600">
                                <li>رقم المعاملة</li>
                                <li>المستخدم</li>
                                <li>نوع المعاملة</li>
                                <li>التاريخ</li>
                                <li>العناصر</li>
                                <li>المجموع</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="submit" id="submit-btn" disabled
                        class="flex-1 px-6 py-3 rounded-lg bg-gradient-to-r from-green-500 to-green-600 text-white font-medium shadow-md hover:from-green-600 hover:to-green-700 hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md">
                        <i class="fas fa-upload ml-2"></i>
                        استيراد
                    </button>
                    <button type="button" onclick="closeImportModal()"
                        class="px-6 py-3 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 transition-all font-medium">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ==================== Infinite Scroll ====================
let nextPage = {% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}null{% endif %};
let hasNext = {% if page_obj.has_next %}true{% else %}false{% endif %};
let isLoading = false;

// Get the main scrollable container (the main element in base.html)
const mainContent = document.querySelector('main.overflow-y-auto');
const tableBody = document.querySelector('tbody.divide-y');
const loadingSpinner = document.getElementById('loading-spinner');
const endOfList = document.getElementById('end-of-list');

// Listen to scroll on the main content area
if (mainContent) {
    mainContent.addEventListener('scroll', handleScroll);
}

// Also listen to window scroll as fallback
window.addEventListener('scroll', handleScroll);

function handleScroll() {
    // Check if scrolled near bottom
    let scrolledToBottom = false;
    
    if (mainContent) {
        const scrollTop = mainContent.scrollTop;
        const scrollHeight = mainContent.scrollHeight;
        const clientHeight = mainContent.clientHeight;
        scrolledToBottom = (scrollTop + clientHeight) >= (scrollHeight - 200);
    } else {
        scrolledToBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200);
    }
    
    if (scrolledToBottom && hasNext && !isLoading) {
        loadMoreData();
    }
}

function loadMoreData() {
    if (!hasNext || isLoading) return;

    isLoading = true;
    loadingSpinner.classList.remove('hidden');
    setTimeout(() => {
    // Build URL with current filters
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('page', nextPage);

    fetch(currentUrl.toString(), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            // Append new rows to table
            data.data.forEach(item => {
                const rowHtml = createTransactionRow(item);
                tableBody.insertAdjacentHTML('beforeend', rowHtml);
            });

            // Update state
            hasNext = data.has_next;
            nextPage = data.next_page_number;
            
            // Show end message if no more data
            if (!hasNext) {
                endOfList.classList.remove('hidden');
            }
        }
    })
    .catch(error => console.error('Error fetching data:', error))
    .finally(() => {
        isLoading = false;
        loadingSpinner.classList.add('hidden');
    });
    }, 1000);
}

function createTransactionRow(item) {
    // Determine type badge colors
    const typeColors = {
        'take': { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-200', icon: 'fa-shopping-cart' },
        'payment': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200', icon: 'fa-dollar-sign' },
        'restore': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200', icon: 'fa-undo' },
        'fees': { bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-200', icon: 'fa-receipt' }
    };
    
    const typeStyle = typeColors[item.type] || typeColors['fees'];
    const userTypeColor = item.user_type === 'merchant' ? 'from-orange-400 to-orange-500' : 'from-purple-400 to-purple-500';
    const userTypeIcon = item.user_type === 'merchant' ? 'fa-store' : 'fa-user-tie';
    const userTypeLabel = item.user_type === 'merchant' ? 'تاجر' : 'مندوب';
    
    // Build user cell
    let userCell = '<span class="text-slate-400 text-sm italic">غير محدد</span>';
    if (item.user) {
        userCell = `
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br ${userTypeColor} flex items-center justify-center shadow-sm">
                    <i class="fas ${userTypeIcon} text-white text-xs"></i>
                </div>
                <div>
                    <p class="font-semibold text-slate-800 text-sm">${item.user_full_name || item.user}</p>
                    <p class="text-xs text-slate-500">${userTypeLabel}</p>
                </div>
            </div>
        `;
    }
    
    // Build items cell
    let itemsCell = '<span class="text-slate-400 text-sm">-</span>';
    if (item.items_count > 0) {
        itemsCell = `
            <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">
                    ${item.items_count}
                </span>
                <button onclick="toggleProducts(${item.id})" class="text-blue-600 hover:text-blue-700 text-xs font-medium">
                    عرض المنتجات
                </button>
            </div>
        `;
    }
    
    // Build amount cell
    let amountCell = '<span class="text-slate-400 text-sm">-</span>';
    if (item.amount) {
        amountCell = `
            <div class="flex items-center gap-1">
                <span class="text-lg font-bold text-slate-800">${parseFloat(item.amount).toFixed(2)}</span>
                <img src="{% static 'images/sar_symbol_dark.svg' %}" class="h-4 inline-block" alt="SAR">
            </div>
        `;
    }
    
    // Build products row (hidden by default)
    let productsRowContent = '';
    if (item.items && item.items.length > 0) {
        const itemRows = item.items.map(i => `
            <tr class="text-right">
                <td class="py-2 px-4">${i.product_name}</td>
                <td class="py-2 px-4">${i.quantity}</td>
                <td class="py-2 px-4">${i.price}</td>
                <td class="py-2 px-4">${i.total}</td>
            </tr>
        `).join('');
        
        productsRowContent = `
            <tr id="products-${item.id}" class="hidden bg-slate-50">
                <td colspan="7" class="py-4 px-4">
                    <div class="bg-white rounded-lg p-4 border border-slate-200">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50">
                                <tr class="text-center">
                                    <th class="py-2 px-4">المنتج</th>
                                    <th class="py-2 px-4">الكمية</th>
                                    <th class="py-2 px-4">السعر</th>
                                    <th class="py-2 px-4">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${itemRows}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        `;
    }
    
    return `
        <tr class="hover:bg-slate-50 transition-all group">
            <td class="py-4 px-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                        <i class="fas fa-hashtag text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-slate-800 text-lg">${item.id}</span>
                </div>
            </td>
            <td class="py-4 px-4">${userCell}</td>
            <td class="py-4 px-4">
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold ${typeStyle.bg} ${typeStyle.text} ${typeStyle.border} border">
                    <i class="fas ${typeStyle.icon}"></i>
                    ${item.type_display}
                </span>
            </td>
            <td class="py-4 px-4">${itemsCell}</td>
            <td class="py-4 px-4">${amountCell}</td>
            <td class="py-4 px-4">
                <div class="flex flex-col">
                    <span class="text-sm font-medium text-slate-700">${item.date || '-'}</span>
                    <span class="text-xs text-slate-500">${item.time || ''}</span>
                </div>
            </td>
            <td class="py-4 px-4">
                <div class="flex items-center gap-2">
                    ${item.user ? `<a href="/representatives/${item.user_id}/" class="p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all" title="عرض التفاصيل"><i class="fas fa-eye"></i></a>` : ''}
                </div>
            </td>
        </tr>
        ${productsRowContent}
    `;
}
// Toggle Products Row
function toggleProducts(transactionId) {
    const row = document.getElementById(`products-${transactionId}`);
    row.classList.toggle('hidden');
}

// Import Modal Functions
const importModal = document.getElementById('import-modal');
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const uploadPrompt = document.getElementById('upload-prompt');
const fileSelected = document.getElementById('file-selected');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const submitBtn = document.getElementById('submit-btn');

function openImportModal() {
    importModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImportModal() {
    importModal.classList.add('hidden');
    document.body.style.overflow = '';
    clearFile();
}

// Click to select file
dropZone.addEventListener('click', () => {
    fileInput.click();
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

// Drag and Drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-green-500', 'bg-green-50');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-green-500', 'bg-green-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-green-500', 'bg-green-50');
    
    if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        // Validate file type
        const validTypes = ['.xlsx', '.xls', '.csv'];
        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
        
        if (validTypes.includes(fileExt)) {
            fileInput.files = e.dataTransfer.files;
            handleFile(file);
        } else {
            alert('يرجى اختيار ملف Excel أو CSV');
        }
    }
});

function handleFile(file) {
    uploadPrompt.classList.add('hidden');
    fileSelected.classList.remove('hidden');
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    submitBtn.disabled = false;
}

function clearFile(event) {
    if (event) event.stopPropagation();
    fileInput.value = '';
    uploadPrompt.classList.remove('hidden');
    fileSelected.classList.add('hidden');
    submitBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !importModal.classList.contains('hidden')) {
        closeImportModal();
    }
});



</script>
{% endblock %}
